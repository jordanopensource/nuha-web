when:
  - event: [push, manual]
    branch:
      exclude: [main]
  - event: [pull_request]
    evaluate: 'CI_COMMIT_TARGET_BRANCH != "main"'

variables:
  - &registry_url "https://registry.cloud.josa.ngo"
  - &docker_repo "registry.cloud.josa.ngo/library/nuha-web"
  - &slack_channel "builds"
  - &success_message >
    âœ… *SUCCESS* - Latest Build #{{ build.number }}

    ğŸ“ *Repository:* {{ repo.name }}
    ğŸŒ¿ *Branch:* {{ build.branch }}
    ğŸ“ *Commit:* {{ truncate build.commit 8 }}
    ğŸ‘¤ *Author:* {{ build.author }}

    ğŸ”— *Links:*
    â€¢ <{{ build.link }}|View Build>
  - &failure_message >
    âŒ *FAILED* - Latest Build #{{ build.number }}

    ğŸ“ *Repository:* {{ repo.name }}
    ğŸŒ¿ *Branch:* {{ build.branch }}
    ğŸ“ *Commit:* {{ truncate build.commit 8 }}
    ğŸ‘¤ *Author:* {{ build.author }}

    ğŸ”— *Links:*
    â€¢ <{{ build.link }}|View Build>

steps:
  - name: run-pre-commit-hooks
    image: josaorg/pre-commit-runner
    settings:
      args: "--all-files"
      skip: "end-of-file-fixer, run-samplr"

  - name: build-latest-image
    image: woodpeckerci/plugin-docker-buildx
    settings:
      repo: *docker_repo
      registry: *registry_url
      dockerfile: ./Dockerfile
      tags:
        - ${CI_COMMIT_SHA:-latest}
        - latest
      username:
        from_secret: REGISTRY_USERNAME
      password:
        from_secret: REGISTRY_SECRET
      build_args:
        - CI_COMMIT_SHA=${CI_COMMIT_SHA}
        - CI_REPO_URL=${CI_REPO_URL}
        - CI_REPO_NAME=${CI_REPO_NAME}
        - CI_PIPELINE_URL=${CI_PIPELINE_URL}
        - CI_PIPELINE_CREATED=${CI_PIPELINE_CREATED}
    depends_on:
      - run-pre-commit-hooks

  - name: notify-slack-latest-success
    image: plugins/slack
    settings:
      webhook:
        from_secret: SLACK_WEBHOOK
      channel: *slack_channel
      template: *success_message
    when:
      - status: success
    depends_on:
      - run-pre-commit-hooks
      - build-latest-image

  - name: notify-slack-latest-failure
    image: plugins/slack
    settings:
      webhook:
        from_secret: SLACK_WEBHOOK
      channel: *slack_channel
      template: *failure_message
    when:
      - status: failure
    depends_on:
      - run-pre-commit-hooks
      - build-latest-image
